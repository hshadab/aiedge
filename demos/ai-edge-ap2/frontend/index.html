<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Edge → AP2 Payment Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-tertiary: #374151;
            --border-color: #374151;
            --text-primary: #f3f4f6;
            --text-secondary: #9ca3af;
            --accent-blue: #3b82f6;
            --accent-green: #22c55e;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #a855f7;
        }

        body {
            background: var(--bg-primary);
            color: var(--text-primary);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }

        /* Panel animations */
        .panel {
            transition: all 0.3s ease;
            border: 2px solid transparent;
            height: 180px;
            overflow: hidden;
        }
        .panel.active {
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        .panel.complete {
            border-color: var(--accent-green);
        }

        /* Fixed height containers */
        .fixed-content {
            height: 140px;
            overflow-y: auto;
        }
        .fixed-content-sm {
            height: 120px;
            overflow-y: auto;
        }

        /* Annotation system */
        .annotation-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 100;
            pointer-events: none;
        }
        .annotation-highlight {
            position: absolute;
            border: 3px solid var(--accent-blue);
            border-radius: 8px;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.5);
            z-index: 120;
            pointer-events: none;
            animation: pulse-highlight 2s infinite;
        }
        @keyframes pulse-highlight {
            0%, 100% { box-shadow: 0 0 20px rgba(59, 130, 246, 0.5); }
            50% { box-shadow: 0 0 40px rgba(59, 130, 246, 0.8); }
        }
        .annotation-tooltip {
            position: absolute;
            background: var(--bg-secondary);
            border: 1px solid var(--accent-blue);
            border-radius: 8px;
            padding: 16px;
            max-width: 320px;
            z-index: 150;
            pointer-events: none;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        .annotation-tooltip h4 {
            color: var(--accent-blue);
            font-weight: 600;
            margin-bottom: 8px;
        }
        .annotation-tooltip p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.5;
        }

        /* Flow arrow animation */
        .flow-arrow {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
        }
        .flow-arrow::before {
            content: '→';
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: color 0.3s;
        }
        .flow-arrow.active::before {
            color: var(--accent-blue);
        }
        .flow-arrow.complete::before {
            color: var(--accent-green);
        }

        /* Scrollable containers with thin scrollbar */
        .thin-scrollbar {
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-tertiary) var(--bg-secondary);
        }
        .thin-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .thin-scrollbar::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .thin-scrollbar::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }

        /* Activity log */
        .activity-log {
            max-height: 200px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--bg-tertiary) var(--bg-secondary);
        }
        .activity-log::-webkit-scrollbar {
            width: 6px;
        }
        .activity-log::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .activity-log::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 3px;
        }


        /* Stage indicators */
        .stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--bg-tertiary);
            transition: all 0.3s;
        }
        .stage-dot.active {
            background: var(--accent-blue);
            animation: pulse 1s infinite;
        }
        .stage-dot.complete {
            background: var(--accent-green);
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }

        /* Run button */
        .run-btn {
            background: linear-gradient(135deg, var(--accent-blue) 0%, #2563eb 100%);
            transition: all 0.2s;
        }
        .run-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
        }
        .run-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Keyboard hint */
        kbd {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.75rem;
            font-family: monospace;
        }

        /* Proof data display */
        .proof-hex {
            font-family: 'Fira Code', monospace;
            font-size: 0.65rem;
            color: var(--accent-green);
            word-break: break-all;
        }

        /* Scanning/typewriter effect */
        .scan-container {
            position: relative;
            overflow: hidden;
        }
        .scan-bar {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background: linear-gradient(90deg, transparent 0%, var(--accent-blue) 50%, transparent 100%);
            box-shadow: 0 0 10px var(--accent-blue), 0 0 20px var(--accent-blue);
            opacity: 0;
            z-index: 10;
            pointer-events: none;
        }
        .scan-bar.active {
            opacity: 1;
            animation: scan-down 1.5s ease-in-out;
        }
        @keyframes scan-down {
            0% { top: 0; opacity: 1; }
            90% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Content reveal animation */
        .reveal-content {
            overflow: hidden;
        }
        .reveal-line {
            opacity: 0;
            transform: translateY(5px);
            transition: all 0.15s ease-out;
        }
        .reveal-line.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* Scrolling content area */
        .scroll-reveal {
            max-height: 100px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-blue) var(--bg-secondary);
        }
        .scroll-reveal::-webkit-scrollbar {
            width: 4px;
        }
        .scroll-reveal::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }
        .scroll-reveal::-webkit-scrollbar-thumb {
            background: var(--accent-blue);
            border-radius: 2px;
        }

        /* Typing cursor effect */
        .typing-cursor::after {
            content: '▌';
            animation: blink 0.7s infinite;
            color: var(--accent-blue);
        }
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        /* Progress bar for proof generation */
        .progress-container {
            width: 100%;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin: 8px 0;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-purple) 0%, var(--accent-blue) 50%, var(--accent-green) 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s linear;
        }
        .progress-bar.active {
            animation: progress-glow 1s ease-in-out infinite;
        }
        @keyframes progress-glow {
            0%, 100% { box-shadow: 0 0 5px var(--accent-purple); }
            50% { box-shadow: 0 0 15px var(--accent-blue); }
        }

        /* Instant flash effect */
        .flash-in {
            animation: flash-appear 0.15s ease-out;
        }
        @keyframes flash-appear {
            0% { opacity: 0; transform: scale(0.95); }
            100% { opacity: 1; transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Controls Bar -->
    <div class="bg-gray-900 border-b border-gray-800 px-6 py-3">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
                <!-- Run Demo Button -->
                <button id="run-btn" onclick="runDemo()" class="run-btn text-white font-semibold px-6 py-2 rounded-lg flex items-center gap-2">
                    <span id="run-icon">▶</span>
                    <span id="run-text">Run Demo</span>
                </button>
                <button onclick="resetDemo()" class="text-sm bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded">
                    Reset
                </button>
                <span id="backend-status" class="text-sm text-gray-400">Connecting...</span>
            </div>
            <div class="text-xs text-gray-500">
                Press <kbd>Space</kbd> to run, <kbd>R</kbd> to reset
            </div>
        </div>
    </div>

    <!-- Header with Title -->
    <header class="bg-gray-800 border-b border-gray-700 px-6 py-4">
        <div class="flex items-center gap-6">
            <!-- Novanet Logo -->
            <img src="https://cdn.prod.website-files.com/65d52b07d5bc41614daa723f/665df12739c532f45b665fe7_logo-novanet.svg" alt="Novanet" class="h-8">
            <div>
                <h1 class="text-lg font-bold">Real zkML Proofs for Google AI Edge Agents</h1>
                <p class="text-xs text-gray-400">Jolt Atlas SNARK proofs for autonomous agent spending via Google AP2</p>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="p-6">
        <!-- Flow Visualization -->
        <div class="flex items-stretch justify-center gap-2 mb-6">
            <!-- Panel 1: AI Edge Agent -->
            <div id="panel-agent" class="panel bg-gray-800 rounded-lg border border-gray-700 p-4 w-52 scan-container">
                <div class="scan-bar" id="scan-agent"></div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="stage-dot" id="stage-agent"></div>
                    <h3 class="font-semibold text-sm">AI Agent</h3>
                    <span class="text-[10px] bg-yellow-900 text-yellow-300 px-1 rounded">SIMULATED</span>
                </div>
                <p class="text-xs text-gray-400 mb-2">LLM makes purchase decision</p>
                <div id="agent-content" class="scroll-reveal text-xs">
                    <div id="agent-status" class="text-gray-500">Waiting...</div>
                </div>
            </div>

            <div class="flow-arrow" id="arrow-1"></div>

            <!-- Panel 2: AI Edge Classifier (NEW - separate from proving) -->
            <div id="panel-classifier" class="panel bg-gray-800 rounded-lg border border-gray-700 p-4 w-52 scan-container">
                <div class="scan-bar" id="scan-classifier"></div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="stage-dot" id="stage-classifier"></div>
                    <h3 class="font-semibold text-sm">AI Edge Classifier</h3>
                </div>
                <p class="text-xs text-gray-400 mb-1">Real <a href="https://ai.google.dev/edge/mediapipe/solutions/text/text_classifier" target="_blank" class="text-blue-400 underline">MediaPipe</a> inference</p>
                <div id="classifier-content" class="scroll-reveal text-xs">
                    <div id="classifier-status" class="text-gray-500">Waiting...</div>
                    <div id="classifier-result" class="hidden mt-1 p-2 bg-gray-900 rounded">
                        <div>Category: <span id="category" class="text-blue-400">—</span></div>
                        <div>Confidence: <span id="confidence" class="text-blue-400">—</span></div>
                        <div>Inference: <span id="inference-time" class="text-cyan-400">—</span></div>
                    </div>
                </div>
            </div>

            <div class="flow-arrow" id="arrow-2"></div>

            <!-- Panel 3: zkML Prover (proves the classifier) -->
            <div id="panel-zkml" class="panel bg-gray-800 rounded-lg border border-gray-700 p-4 w-52 scan-container">
                <div class="scan-bar" id="scan-zkml"></div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="stage-dot" id="stage-zkml"></div>
                    <h3 class="font-semibold text-sm">zkML Prover</h3>
                </div>
                <p class="text-xs text-gray-400 mb-1">Proves classifier ran correctly</p>
                <div id="zkml-content" class="scroll-reveal text-xs">
                    <div id="zkml-status" class="text-gray-500">Waiting...</div>
                    <div id="zkml-result" class="hidden mt-1 p-2 bg-gray-900 rounded">
                        <div>Prove: <span id="proof-time" class="text-green-400">—</span></div>
                        <div>Verify: <span id="verify-time" class="text-green-400">—</span></div>
                    </div>
                </div>
            </div>

            <div class="flow-arrow" id="arrow-3"></div>

            <!-- Panel 4: Policy Engine -->
            <div id="panel-policy" class="panel bg-gray-800 rounded-lg border border-gray-700 p-4 w-52 scan-container">
                <div class="scan-bar" id="scan-policy"></div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="stage-dot" id="stage-policy"></div>
                    <h3 class="font-semibold text-sm">Policy Engine</h3>
                </div>
                <p class="text-xs text-gray-400 mb-1">Enterprise spending rules</p>
                <div id="policy-content" class="scroll-reveal text-xs">
                    <div id="policy-status" class="text-gray-500">Waiting...</div>
                    <div id="policy-result" class="hidden mt-1 p-2 bg-gray-900 rounded">
                        <div id="policy-checks"></div>
                    </div>
                </div>
            </div>

            <div class="flow-arrow" id="arrow-4"></div>

            <!-- Panel 5: AP2 Payment -->
            <div id="panel-ap2" class="panel bg-gray-800 rounded-lg border border-gray-700 p-4 w-52 scan-container">
                <div class="scan-bar" id="scan-ap2"></div>
                <div class="flex items-center gap-2 mb-2">
                    <div class="stage-dot" id="stage-ap2"></div>
                    <h3 class="font-semibold text-sm">AP2 Payment</h3>
                </div>
                <p class="text-xs text-gray-400 mb-1">Real <a href="https://github.com/google-agentic-commerce/AP2" target="_blank" class="text-blue-400 underline">Google AP2</a> types</p>
                <div id="ap2-content" class="scroll-reveal text-xs">
                    <div id="ap2-status" class="text-gray-500">Waiting...</div>
                    <div id="ap2-result" class="hidden mt-1 p-2 bg-gray-900 rounded">
                        <div>Transaction: <span id="ap2-txn" class="text-green-400">—</span></div>
                        <div>Amount: <span id="ap2-amount" class="text-white">—</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Function Call Display -->
        <div class="grid grid-cols-2 gap-6 mb-6">
            <div id="function-call-panel" class="bg-gray-800 rounded-lg border border-gray-700 p-4 h-44 scan-container">
                <div class="scan-bar" id="scan-function"></div>
                <h3 class="text-sm font-semibold mb-2 text-gray-300">Function Call (AI Edge Output)</h3>
                <div id="function-call" class="bg-gray-900 rounded p-3 text-xs text-green-400 font-mono h-28 thin-scrollbar overflow-y-auto">
                    <div class="text-gray-500">Waiting...</div>
                </div>
            </div>

            <div id="proof-bundle-panel" class="bg-gray-800 rounded-lg border border-gray-700 p-4 h-44 scan-container">
                <div class="scan-bar" id="scan-proof"></div>
                <h3 class="text-sm font-semibold mb-2 text-gray-300">SpendingProof (Attached to AP2 Payment)</h3>
                <div id="proof-bundle" class="bg-gray-900 rounded p-3 text-xs h-28 thin-scrollbar overflow-y-auto">
                    <div class="text-gray-500">Waiting...</div>
                </div>
            </div>
        </div>

        <!-- Activity Log -->
        <div class="bg-gray-800 rounded-lg border border-gray-700 p-4 mb-6 h-56">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-300 flex items-center gap-2">
                    <span id="log-indicator" class="w-2 h-2 rounded-full bg-gray-600"></span>
                    Activity Log
                </h3>
                <span id="log-count" class="text-xs text-gray-500">0 events</span>
            </div>
            <div id="activity-log" class="activity-log bg-gray-900 rounded p-3 text-xs font-mono h-36">
                <div class="text-gray-500">Press <kbd>Space</kbd> or click "Run Demo" to start...</div>
            </div>
        </div>

    </main>

    <!-- Annotation System (auto-advances, no manual controls) -->
    <div id="annotation-overlay" class="annotation-overlay hidden"></div>
    <div id="annotation-highlight" class="annotation-highlight hidden"></div>
    <div id="annotation-tooltip" class="annotation-tooltip hidden">
        <h4 id="annotation-title"></h4>
        <p id="annotation-text"></p>
    </div>

    <script>
        const API_BASE = 'http://localhost:3001';

        // Demo state
        let isRunning = false;
        let demoData = null;
        let activityLog = [];

        // Annotation definitions
        const ANNOTATIONS = [
            {
                target: '#panel-agent',
                title: '1. AI Agent (Simulated)',
                text: 'The AI agent makes an autonomous purchase decision. In production, this would be Gemma or another LLM running on-device. Currently simulated for the demo.',
                position: 'bottom'
            },
            {
                target: '#panel-classifier',
                title: '2. AI Edge Classifier (Real)',
                text: 'Real MediaPipe text classifier runs to categorize the spending. This is actual Google AI Edge inference running locally in ~1-2ms.',
                position: 'bottom'
            },
            {
                target: '#panel-zkml',
                title: '3. zkML Prover (Real)',
                text: 'Jolt Atlas generates a SNARK proof that the classifier ran correctly. Anyone can verify this proof without re-running inference.',
                position: 'bottom'
            },
            {
                target: '#panel-policy',
                title: '4. Policy Engine',
                text: 'Enterprise spending rules are enforced: category limits, approved vendors, daily budgets. The zkML proof attests to the classification.',
                position: 'bottom'
            },
            {
                target: '#panel-ap2',
                title: '5. AP2 Payment (Real Types)',
                text: 'Payment uses real Google AP2 types. The SpendingProof is attached as PaymentMethodData, enabling trustless autonomous commerce.',
                position: 'bottom'
            }
        ];

        let currentAnnotation = 0;
        let annotationTimer = null;
        const ANNOTATION_DELAY = 4000; // 4 seconds per annotation

        // Check backend status
        async function checkBackend() {
            try {
                const res = await fetch(`${API_BASE}/health`);
                if (res.ok) {
                    document.getElementById('backend-status').textContent = '● Backend Connected';
                    document.getElementById('backend-status').classList.remove('text-red-400');
                    document.getElementById('backend-status').classList.add('text-green-400');
                    return true;
                }
            } catch (e) {
                document.getElementById('backend-status').textContent = '○ Backend Offline';
                document.getElementById('backend-status').classList.remove('text-green-400');
                document.getElementById('backend-status').classList.add('text-red-400');
            }
            return false;
        }

        // Add log entry
        function addLog(type, message, details = '') {
            const icons = {
                agent: '◉',
                proof: '◈',
                policy: '✓',
                payment: '⬡',
                success: '★',
                warning: '!',
                error: '✗'
            };
            const colors = {
                agent: 'text-blue-400',
                proof: 'text-purple-400',
                policy: 'text-yellow-400',
                payment: 'text-cyan-400',
                success: 'text-green-400',
                warning: 'text-yellow-400',
                error: 'text-red-400'
            };

            const time = new Date().toLocaleTimeString('en-US', { hour12: false });
            const entry = { time, type, message, details };
            activityLog.push(entry);

            const logEl = document.getElementById('activity-log');
            const entryHtml = `<div class="py-1">
                <span class="text-gray-500">[${time}]</span>
                <span class="${colors[type]}">${icons[type]}</span>
                <span class="text-gray-300">${message}</span>
                ${details ? `<span class="text-gray-500"> — ${details}</span>` : ''}
            </div>`;

            if (activityLog.length === 1) {
                logEl.innerHTML = entryHtml;
            } else {
                logEl.innerHTML += entryHtml;
            }
            logEl.scrollTop = logEl.scrollHeight;

            document.getElementById('log-count').textContent = `${activityLog.length} events`;
            document.getElementById('log-indicator').classList.remove('bg-gray-600');
            document.getElementById('log-indicator').classList.add('bg-green-500');
        }

        // Update panel state
        function setPanelState(panelId, state) {
            const panel = document.getElementById(panelId);
            const stage = document.getElementById(panelId.replace('panel-', 'stage-'));

            panel.classList.remove('active', 'complete');
            stage.classList.remove('active', 'complete');

            if (state === 'active') {
                panel.classList.add('active');
                stage.classList.add('active');
            } else if (state === 'complete') {
                panel.classList.add('complete');
                stage.classList.add('complete');
            }
        }

        // Update arrow state
        function setArrowState(arrowId, state) {
            const arrow = document.getElementById(arrowId);
            arrow.classList.remove('active', 'complete');
            if (state) arrow.classList.add(state);
        }

        // Sleep helper
        const sleep = ms => new Promise(r => setTimeout(r, ms));

        // Trigger scan bar animation
        function triggerScan(panelName) {
            const scanBar = document.getElementById(`scan-${panelName}`);
            if (scanBar) {
                scanBar.classList.remove('active');
                void scanBar.offsetWidth; // Force reflow
                scanBar.classList.add('active');
            }
        }

        // Typewriter effect for a text element
        async function typeWriter(element, text, speed = 30) {
            element.textContent = '';
            element.classList.add('typing-cursor');
            for (let i = 0; i < text.length; i++) {
                element.textContent += text[i];
                // Auto-scroll parent if needed
                const parent = element.closest('.scroll-reveal');
                if (parent) parent.scrollTop = parent.scrollHeight;
                await sleep(speed);
            }
            element.classList.remove('typing-cursor');
        }

        // Reveal content line by line with scroll
        async function revealLines(container, lines, delayBetween = 150) {
            container.innerHTML = '';
            for (const line of lines) {
                const div = document.createElement('div');
                div.className = 'reveal-line';
                div.innerHTML = line;
                container.appendChild(div);
                await sleep(50);
                div.classList.add('visible');
                container.scrollTop = container.scrollHeight;
                await sleep(delayBetween);
            }
        }

        // Add content to a panel with auto-scroll
        function appendToPanel(contentId, html) {
            const container = document.getElementById(contentId);
            if (container) {
                const div = document.createElement('div');
                div.className = 'reveal-line';
                div.innerHTML = html;
                container.appendChild(div);
                requestAnimationFrame(() => {
                    div.classList.add('visible');
                    container.scrollTop = container.scrollHeight;
                });
            }
        }

        // Run the demo
        async function runDemo() {
            if (isRunning) return;

            const backendOk = await checkBackend();
            if (!backendOk) {
                addLog('error', 'Backend not available', 'Start the backend server first');
                return;
            }

            isRunning = true;
            document.getElementById('run-btn').disabled = true;
            document.getElementById('run-icon').textContent = '●';
            document.getElementById('run-text').textContent = 'Running...';

            // Reset UI
            activityLog = [];
            document.getElementById('activity-log').innerHTML = '';
            ['panel-agent', 'panel-classifier', 'panel-zkml', 'panel-policy', 'panel-ap2'].forEach(p => setPanelState(p, ''));
            ['arrow-1', 'arrow-2', 'arrow-3', 'arrow-4'].forEach(a => setArrowState(a, ''));
            // Reset content areas
            document.getElementById('agent-content').innerHTML = '';
            document.getElementById('classifier-content').innerHTML = '';
            document.getElementById('zkml-content').innerHTML = '';
            document.getElementById('policy-content').innerHTML = '';
            document.getElementById('ap2-content').innerHTML = '';
            document.getElementById('function-call').innerHTML = '<div class="text-gray-500">Generating...</div>';
            document.getElementById('proof-bundle').innerHTML = '<div class="text-gray-500">Generating...</div>';
            // Reset scan bars
            ['scan-agent', 'scan-classifier', 'scan-zkml', 'scan-policy', 'scan-ap2', 'scan-function', 'scan-proof'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });

            try {
                // Stage 1: AI Agent - with scanning effect
                addLog('agent', 'AI Edge agent initiated', 'Gemma on LiteRT');
                setPanelState('panel-agent', 'active');
                triggerScan('agent');

                // Clear and reveal content line by line
                const agentContent = document.getElementById('agent-content');
                agentContent.innerHTML = '';

                await sleep(200);
                appendToPanel('agent-content', '<span class="text-blue-400">▸ Initializing LLM...</span>');
                await sleep(400);
                appendToPanel('agent-content', '<span class="text-blue-400">▸ Processing request...</span>');
                await sleep(400);

                addLog('agent', 'Analyzing delivery delay', 'Route optimization needed');
                appendToPanel('agent-content', '<span class="text-cyan-400">▸ Analyzing context...</span>');
                await sleep(300);
                appendToPanel('agent-content', '<span class="text-cyan-400">▸ Delivery delay detected</span>');
                await sleep(300);

                addLog('agent', 'Decision: Purchase route data', '$12.00 from HERE Maps');
                appendToPanel('agent-content', '<span class="text-yellow-400">▸ Decision: purchase_data</span>');
                await sleep(200);
                appendToPanel('agent-content', '<span class="text-green-400">✓ Function call ready</span>');

                // Type out function call JSON line by line
                triggerScan('function');
                const funcCallEl = document.getElementById('function-call');
                funcCallEl.innerHTML = '';
                const funcCallLines = [
                    '{',
                    '  <span class="text-purple-400">"function"</span>: <span class="text-yellow-400">"purchase_data_service"</span>,',
                    '  <span class="text-purple-400">"vendor"</span>: <span class="text-yellow-400">"vendor:here_routing"</span>,',
                    '  <span class="text-purple-400">"amount_cents"</span>: <span class="text-cyan-400">1200</span>,',
                    '  <span class="text-purple-400">"service"</span>: <span class="text-yellow-400">"premium_route_optimization"</span>,',
                    '  <span class="text-purple-400">"context"</span>: {',
                    '    <span class="text-purple-400">"delivery_id"</span>: <span class="text-yellow-400">"DEL-4521"</span>,',
                    '    <span class="text-purple-400">"urgency"</span>: <span class="text-yellow-400">"high"</span>',
                    '  }',
                    '}'
                ];
                for (const line of funcCallLines) {
                    const div = document.createElement('div');
                    div.className = 'reveal-line';
                    div.innerHTML = line;
                    funcCallEl.appendChild(div);
                    await sleep(80);
                    div.classList.add('visible');
                    funcCallEl.scrollTop = funcCallEl.scrollHeight;
                }

                setPanelState('panel-agent', 'complete');
                setArrowState('arrow-1', 'active');
                await sleep(300);

                // Stage 2: AI Edge Classifier (Real MediaPipe) - INSTANT (1-2ms)
                addLog('agent', 'Running AI Edge classifier', 'Real MediaPipe inference');
                setPanelState('panel-classifier', 'active');
                setArrowState('arrow-1', 'complete');
                triggerScan('classifier');

                const classifierContent = document.getElementById('classifier-content');
                classifierContent.innerHTML = '<span class="text-blue-400">▸ Running inference...</span>';

                // Call backend - this does both classification AND proving
                const classifyRes = await fetch(`${API_BASE}/api/v1/demo/trigger/route_purchase`, { method: 'POST' });
                demoData = await classifyRes.json();

                // INSTANT flash - inference is ~1ms, should feel immediate
                const inferenceTimeMs = demoData.inference_time_ms || 1.5;
                classifierContent.innerHTML = `
                    <div class="flash-in">
                        <div class="text-cyan-400">▸ Inference: <strong>${inferenceTimeMs.toFixed(1)}ms</strong></div>
                        <div class="text-yellow-400">▸ Category: <strong>${demoData.classification.category}</strong></div>
                        <div class="text-yellow-400">▸ Confidence: <strong>${(demoData.classification.confidence * 100).toFixed(0)}%</strong></div>
                        <div class="text-green-400 mt-1">✓ Complete</div>
                    </div>
                `;

                addLog('success', `Classification: ${demoData.classification.category}`, `${(demoData.classification.confidence * 100).toFixed(0)}% confidence, ${inferenceTimeMs.toFixed(1)}ms`);
                setPanelState('panel-classifier', 'complete');
                setArrowState('arrow-2', 'active');
                await sleep(200);

                // Stage 3: zkML Prover (proves the classifier ran correctly) - SLOW (~5-7s)
                addLog('proof', 'Generating zkML proof', 'Proving classifier ran correctly');
                setPanelState('panel-zkml', 'active');
                setArrowState('arrow-2', 'complete');
                triggerScan('zkml');

                const zkmlContent = document.getElementById('zkml-content');
                const proveTimeSec = (demoData.proving_time_ms / 1000).toFixed(2);
                const verifyTimeSec = demoData.verification_time_ms ? (demoData.verification_time_ms / 1000).toFixed(2) : '—';
                const totalTime = demoData.proving_time_ms + (demoData.verification_time_ms || 0);

                // Show progress bar with live timer
                zkmlContent.innerHTML = `
                    <div class="text-purple-400 mb-1">▸ Generating SNARK proof...</div>
                    <div class="progress-container">
                        <div class="progress-bar active" id="proof-progress"></div>
                    </div>
                    <div class="text-gray-400 text-[10px]" id="proof-timer">Elapsed: 0.0s</div>
                `;

                // Animate progress bar over the actual proof time
                const progressBar = document.getElementById('proof-progress');
                const timerEl = document.getElementById('proof-timer');
                const startTime = Date.now();
                const animDuration = Math.min(totalTime * 0.8, 6000); // Cap at 6s animation

                await new Promise(resolve => {
                    const interval = setInterval(() => {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min((elapsed / animDuration) * 100, 100);
                        progressBar.style.width = progress + '%';
                        timerEl.textContent = `Elapsed: ${(elapsed / 1000).toFixed(1)}s`;

                        if (progress >= 100) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 50);
                });

                // Show final results
                progressBar.classList.remove('active');
                zkmlContent.innerHTML = `
                    <div class="flash-in">
                        <div class="text-purple-400">▸ SNARK generated</div>
                        <div class="text-cyan-400">▸ Prove: <strong>${proveTimeSec}s</strong></div>
                        <div class="text-cyan-400">▸ Verify: <strong>${verifyTimeSec}s</strong></div>
                        <div class="text-green-400 mt-1">✓ Proof verified</div>
                    </div>
                `;

                addLog('proof', 'SNARK proof generated & verified', `Prove: ${proveTimeSec}s, Verify: ${verifyTimeSec}s`);
                setPanelState('panel-zkml', 'complete');
                setArrowState('arrow-3', 'active');

                // Show proof bundle with typewriter effect and scanning
                if (demoData.proof_bundle) {
                    triggerScan('proof');
                    const proofEl = document.getElementById('proof-bundle');
                    proofEl.innerHTML = '';

                    const proofLines = [
                        '<span class="text-gray-400">classification_proof:</span>',
                        `<span class="proof-hex">${demoData.proof_bundle.classification_proof.slice(0, 40)}</span>`,
                        `<span class="proof-hex">${demoData.proof_bundle.classification_proof.slice(40, 80)}...</span>`,
                        '<span class="text-gray-400 mt-2">policy_attestation:</span>',
                        `<span class="proof-hex">${demoData.proof_bundle.policy_attestation.slice(0, 50)}</span>`,
                        `<span class="proof-hex">${demoData.proof_bundle.policy_attestation.slice(50, 100)}...</span>`,
                        '<span class="text-gray-400 mt-2">model_hash:</span>',
                        `<span class="proof-hex">${demoData.proof_bundle.model_hash}</span>`
                    ];

                    for (const line of proofLines) {
                        const div = document.createElement('div');
                        div.className = 'reveal-line';
                        div.innerHTML = line;
                        proofEl.appendChild(div);
                        await sleep(120);
                        div.classList.add('visible');
                        proofEl.scrollTop = proofEl.scrollHeight;
                    }
                }
                await sleep(300);

                // Stage 4: Policy Engine
                addLog('policy', 'Checking enterprise spending policy', 'Acme Fleet Policy');
                setPanelState('panel-policy', 'active');
                setArrowState('arrow-3', 'complete');
                triggerScan('policy');

                const policyContent = document.getElementById('policy-content');
                policyContent.innerHTML = '';

                await sleep(200);
                appendToPanel('policy-content', '<span class="text-blue-400">▸ Loading policy...</span>');
                await sleep(300);
                appendToPanel('policy-content', '<span class="text-blue-400">▸ Evaluating rules...</span>');
                await sleep(300);

                // Show policy checks one by one
                for (const check of demoData.policy_check.checks_passed) {
                    appendToPanel('policy-content', `<span class="text-green-400">✓ ${check.replace('_', ' ')}</span>`);
                    await sleep(200);
                }
                for (const check of demoData.policy_check.checks_failed) {
                    appendToPanel('policy-content', `<span class="text-red-400">✗ ${check.replace('_', ' ')}</span>`);
                    await sleep(200);
                }

                if (demoData.policy_check.allowed) {
                    addLog('success', 'Policy check: APPROVED', demoData.policy_check.reason);
                    appendToPanel('policy-content', '<span class="text-green-400 font-semibold">✓ APPROVED</span>');
                } else {
                    addLog('warning', 'Policy check: DENIED', demoData.policy_check.reason);
                    appendToPanel('policy-content', '<span class="text-red-400 font-semibold">✗ DENIED</span>');
                }

                setPanelState('panel-policy', 'complete');
                setArrowState('arrow-4', 'active');
                await sleep(300);

                // Stage 5: AP2 Payment
                setPanelState('panel-ap2', 'active');
                setArrowState('arrow-4', 'complete');
                triggerScan('ap2');

                const ap2Content = document.getElementById('ap2-content');
                ap2Content.innerHTML = '';

                if (demoData.payment_ready) {
                    addLog('payment', 'Initiating AP2 payment', 'Google Agent-to-Payment');

                    await sleep(200);
                    appendToPanel('ap2-content', '<span class="text-blue-400">▸ Connecting to AP2...</span>');
                    await sleep(300);
                    appendToPanel('ap2-content', '<span class="text-blue-400">▸ Processing payment...</span>');

                    // Process payment
                    const payRes = await fetch(`${API_BASE}/api/v1/ap2/pay`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ transaction_id: demoData.transaction_id })
                    });
                    const payData = await payRes.json();

                    await sleep(200);
                    if (payData.success) {
                        appendToPanel('ap2-content', '<span class="text-cyan-400">▸ Payment authorized</span>');
                        await sleep(150);
                        appendToPanel('ap2-content', `<span class="text-yellow-400">▸ Amount: $12.00 USD</span>`);
                        await sleep(150);
                        appendToPanel('ap2-content', `<span class="text-gray-400">▸ Txn: ${payData.ap2_transaction_id.slice(0, 12)}...</span>`);
                        await sleep(150);
                        appendToPanel('ap2-content', '<span class="text-green-400 font-semibold">✓ Settlement complete</span>');

                        addLog('success', 'Payment complete!', payData.ap2_transaction_id);
                    } else {
                        appendToPanel('ap2-content', `<span class="text-red-400">✗ ${payData.message}</span>`);
                        addLog('error', 'Payment failed', payData.message);
                    }
                } else {
                    appendToPanel('ap2-content', '<span class="text-red-400">▸ Payment blocked</span>');
                    await sleep(150);
                    appendToPanel('ap2-content', `<span class="text-red-400">✗ ${demoData.policy_check.reason}</span>`);
                    addLog('warning', 'Payment blocked', demoData.policy_check.reason);
                }

                setPanelState('panel-ap2', 'complete');

                // Demo complete - show annotations
                addLog('success', 'Demo complete', 'End-to-end flow finished');
                await sleep(1500);
                showAnnotations();

            } catch (e) {
                addLog('error', 'Demo error', e.message);
                console.error(e);
            }

            isRunning = false;
            document.getElementById('run-btn').disabled = false;
            document.getElementById('run-icon').textContent = '▶';
            document.getElementById('run-text').textContent = 'Run Demo';
        }

        // Reset demo
        function resetDemo() {
            if (isRunning) return;

            activityLog = [];
            demoData = null;
            document.getElementById('activity-log').innerHTML = '<div class="text-gray-500">Press <kbd>Space</kbd> or click "Run Demo" to start...</div>';
            document.getElementById('log-count').textContent = '0 events';
            document.getElementById('log-indicator').classList.remove('bg-green-500');
            document.getElementById('log-indicator').classList.add('bg-gray-600');

            ['panel-agent', 'panel-classifier', 'panel-zkml', 'panel-policy', 'panel-ap2'].forEach(p => {
                setPanelState(p, '');
            });
            ['arrow-1', 'arrow-2', 'arrow-3', 'arrow-4'].forEach(a => setArrowState(a, ''));

            // Reset content areas with waiting state
            document.getElementById('agent-content').innerHTML = '<div class="text-gray-500">Waiting...</div>';
            document.getElementById('classifier-content').innerHTML = '<div class="text-gray-500">Waiting...</div>';
            document.getElementById('zkml-content').innerHTML = '<div class="text-gray-500">Waiting...</div>';
            document.getElementById('policy-content').innerHTML = '<div class="text-gray-500">Waiting...</div>';
            document.getElementById('ap2-content').innerHTML = '<div class="text-gray-500">Waiting...</div>';

            // Remove scan bar active state
            ['scan-agent', 'scan-classifier', 'scan-zkml', 'scan-policy', 'scan-ap2', 'scan-function', 'scan-proof'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('active');
            });

            document.getElementById('function-call').innerHTML = '<div class="text-gray-500">Waiting...</div>';
            document.getElementById('proof-bundle').innerHTML = '<div class="text-gray-500">Waiting...</div>';

            // Close any open annotations
            closeAnnotations();

            // Reset backend
            fetch(`${API_BASE}/api/v1/demo/reset`, { method: 'POST' }).catch(() => {});
        }

        // Annotation functions (fully automatic)
        function showAnnotations() {
            currentAnnotation = 0;
            updateAnnotation();
            annotationTimer = setInterval(() => {
                if (currentAnnotation < ANNOTATIONS.length - 1) {
                    currentAnnotation++;
                    updateAnnotation();
                } else {
                    closeAnnotations();
                }
            }, ANNOTATION_DELAY);
        }

        function closeAnnotations() {
            if (annotationTimer) {
                clearInterval(annotationTimer);
                annotationTimer = null;
            }
            document.getElementById('annotation-overlay').classList.add('hidden');
            document.getElementById('annotation-highlight').classList.add('hidden');
            document.getElementById('annotation-tooltip').classList.add('hidden');
        }

        function updateAnnotation() {
            const ann = ANNOTATIONS[currentAnnotation];
            const target = document.querySelector(ann.target);
            if (!target) return;

            const rect = target.getBoundingClientRect();

            // Show overlay
            document.getElementById('annotation-overlay').classList.remove('hidden');

            // Position highlight
            const highlight = document.getElementById('annotation-highlight');
            highlight.classList.remove('hidden');
            highlight.style.top = (rect.top + window.scrollY - 4) + 'px';
            highlight.style.left = (rect.left - 4) + 'px';
            highlight.style.width = (rect.width + 8) + 'px';
            highlight.style.height = (rect.height + 8) + 'px';

            // Update and position tooltip
            const tooltip = document.getElementById('annotation-tooltip');
            tooltip.classList.remove('hidden');
            document.getElementById('annotation-title').textContent = ann.title;
            document.getElementById('annotation-text').textContent = ann.text;

            if (ann.position === 'bottom') {
                tooltip.style.top = (rect.bottom + window.scrollY + 12) + 'px';
                tooltip.style.left = rect.left + 'px';
            } else {
                tooltip.style.top = (rect.top + window.scrollY - 100) + 'px';
                tooltip.style.left = rect.left + 'px';
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

            if (e.code === 'Space' && !isRunning) {
                e.preventDefault();
                runDemo();
            } else if (e.code === 'KeyR') {
                e.preventDefault();
                resetDemo();
            } else if (e.code === 'Escape') {
                closeAnnotations();
            }
        });

        // Initialize
        checkBackend();
        setInterval(checkBackend, 5000);
    </script>
</body>
</html>
